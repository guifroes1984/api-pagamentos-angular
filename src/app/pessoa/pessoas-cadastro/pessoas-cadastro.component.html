<div class="min-vh-100 bg-light pt-5">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-10">
        <div class="card shadow-lg border-0 rounded-3">
          <div class="card-header bg-primary text-white py-3 rounded-top">
            <div class="row align-items-center">
              <div class="col">
                <h1 class="h3 mb-0 fw-bold">
                  <i class="bi bi-person me-2"></i>
                  {{ editando ? 'Edição de Pessoa' : 'Nova Pessoa' }}
                </h1>
              </div>
            </div>
          </div>

          <div class="card-body p-4">
            <form [formGroup]="formPessoa" autocomplete="off" (ngSubmit)="salvar()">

              <div class="mb-4">
                <label class="form-label fw-semibold">Nome</label>
                <input type="text" class="form-control" formControlName="nome"
                  [ngClass]="{'is-invalid': formPessoa.get('nome')?.invalid && formPessoa.get('nome')?.touched}">
                <div class="invalid-feedback"
                  *ngIf="formPessoa.get('nome')?.hasError('required') && formPessoa.get('nome')?.touched">
                  Informe o nome
                </div>
                <div class="invalid-feedback"
                  *ngIf="formPessoa.get('nome')?.hasError('tamanhoMinimo') && formPessoa.get('nome')?.touched">
                  Mínimo de {{ formPessoa.get('nome')?.errors?.['tamanhoMinimo']?.tamanho }} caracteres
                </div>
              </div>

              <div formGroupName="endereco">
                <div class="row g-3 mb-3">
                  <div class="col-md-8">
                    <label class="form-label fw-semibold">Logradouro</label>
                    <input type="text" class="form-control" formControlName="logradouro"
                      [ngClass]="{'is-invalid': formPessoa.get('endereco.logradouro')?.invalid && formPessoa.get('endereco.logradouro')?.touched}">
                    <div class="invalid-feedback"
                      *ngIf="formPessoa.get('endereco.logradouro')?.hasError('required') && formPessoa.get('endereco.logradouro')?.touched">
                      Informe o logradouro
                    </div>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label fw-semibold">Número</label>
                    <input type="text" class="form-control" formControlName="numero"
                      [ngClass]="{'is-invalid': formPessoa.get('endereco.numero')?.invalid && formPessoa.get('endereco.numero')?.touched}">
                    <div class="invalid-feedback"
                      *ngIf="formPessoa.get('endereco.numero')?.hasError('required') && formPessoa.get('endereco.numero')?.touched">
                      Informe o número
                    </div>
                  </div>
                </div>

                <div class="row g-3 mb-3">
                  <div class="col-md-4">
                    <label class="form-label fw-semibold">Complemento</label>
                    <input type="text" class="form-control" formControlName="complemento">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label fw-semibold">Bairro</label>
                    <input type="text" class="form-control" formControlName="bairro"
                      [ngClass]="{'is-invalid': formPessoa.get('endereco.bairro')?.invalid && formPessoa.get('endereco.bairro')?.touched}">
                    <div class="invalid-feedback"
                      *ngIf="formPessoa.get('endereco.bairro')?.hasError('required') && formPessoa.get('endereco.bairro')?.touched">
                      Informe o bairro
                    </div>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label fw-semibold">CEP</label>
                    <input type="text" class="form-control" formControlName="cep" placeholder="00000-000"
                      mask="00000-000"
                      [ngClass]="{'is-invalid': formPessoa.get('endereco.cep')?.invalid && formPessoa.get('endereco.cep')?.touched}">
                    <div class="invalid-feedback"
                      *ngIf="formPessoa.get('endereco.cep')?.hasError('required') && formPessoa.get('endereco.cep')?.touched">
                      Informe o CEP
                    </div>
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-semibold">Estado</label>
                    <mat-form-field appearance="outline" class="w-100 bootstrap-size">
                      <mat-select formControlName="estado" (selectionChange)="carregarCidades($event.value)">
                        <mat-option *ngFor="let estado of estadosFiltrados" [value]="estado.value">
                          {{ estado.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-semibold">Cidade</label>
                    <mat-form-field appearance="outline" class="w-100 bootstrap-size">
                      <mat-select formControlName="cidade">
                        <mat-option *ngFor="let cidade of cidadesFiltradas" [value]="cidade.codigo">
                          {{ cidade.nome }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0 fw-bold text-primary">Contatos</h5>
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="prepararNovoContato()">
                    <i class="bi bi-plus-circle me-1"></i>Novo Contato
                  </button>
                </div>

                <div class="table-responsive">
                  <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th class="text-left">Nome</th>
                        <th class="text-left">E-mail</th>
                        <th class="text-center">Telefone</th>
                        <th class="text-center" style="width: 120px;">Ações</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let contato of fonteDados.data; let i = index">
                        <td class="text-left">{{ contato.nome }}</td>
                        <td class="text-left">{{ contato.email }}</td>
                        <td class="text-center">{{ contato.telefone }}</td>
                        <td class="text-center">
                          <div class="d-flex gap-2 justify-content-center">
                            <button type="button" class="btn btn-outline-primary btn-sm" (click)="editarContato(i)"
                              title="Editar">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" (click)="excluirContato(i)"
                              title="Excluir">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>

                      <tr *ngIf="fonteDados.data.length === 0">
                        <td colspan="4" class="text-center text-muted py-4">
                          <i class="bi bi-inbox display-6 d-block mb-2"></i>
                          {{ editando ? 'Nenhum contato encontrado.' : 'Nenhum contato adicionado ainda. Use o botão
                          acima para incluir.' }}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="d-flex gap-2 flex-column flex-md-row mt-4 border-top pt-4">
                <button class="btn btn-primary" type="submit" [disabled]="formPessoa.invalid">
                  <i class="bi bi-save me-2"></i>Salvar
                </button>
                <button class="btn btn-outline-secondary" type="button" (click)="novo()">
                  <i class="bi bi-plus-circle me-2"></i>Novo
                </button>
                <a class="btn btn-outline-danger ms-auto" routerLink="/pessoas">
                  <i class="bi bi-arrow-left me-2"></i>Voltar
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>